# RushTI Build Workflow
#
# Builds Windows executable when Python/application code changes.
# Only triggers after tests pass or on manual dispatch.

name: Build

on:
  push:
    branches: [master, rushti2dot0]
    paths:
      - 'src/**'
      - 'pyproject.toml'
      - '*.py'
      - '*.spec'
      - 'config/**'
      - 'assets/**'
      - '.github/workflows/build.yml'
  workflow_dispatch:  # Allow manual triggering
  workflow_run:
    workflows: ["Tests"]
    types: [completed]
    branches: [master, rushti2dot0]

jobs:
  build-windows:
    name: Build Windows Executable
    runs-on: windows-latest
    # Only build if:
    # - Tests workflow succeeded, OR
    # - Manually triggered, OR
    # - Direct push (tests will run in parallel via path filter)
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pyinstaller>=6.0.0
        shell: bash

      - name: Build executable
        run: |
          pyinstaller rushti.spec --clean
        shell: bash

      - name: Verify build
        run: |
          echo "Build output structure (onedir mode):"
          ls -la dist/
          ls -la dist/rushti/
        shell: bash

      - name: Test executable
        run: |
          echo "Testing rushti.exe..."
          dist/rushti/rushti.exe --help
          if [ $? -eq 0 ]; then
            echo "✓ Executable runs successfully"
          else
            echo "✗ Executable failed to run"
            exit 1
          fi
        shell: bash

      - name: Create release package
        run: |
          mkdir -p release/rushti-windows

          # Copy the entire onedir distribution (includes exe and all dependencies)
          cp -r dist/rushti/* release/rushti-windows/

          # Create config directory structure
          mkdir -p release/rushti-windows/config

          # Copy configuration templates if they exist
          if [ -f "config/config.ini.template" ]; then
            cp config/config.ini.template release/rushti-windows/config/
          fi
          if [ -f "config/logging_config.ini" ]; then
            cp config/logging_config.ini release/rushti-windows/config/
          fi
          if [ -f "config/settings.ini.template" ]; then
            cp config/settings.ini.template release/rushti-windows/config/
          fi

          # Copy assets directory (required for 'build' command to create TM1 objects)
          # Note: Assets are also bundled in the distribution, but including them in the
          # release allows users to customize the TM1 object definitions if needed
          if [ -d "assets" ]; then
            cp -r assets release/rushti-windows/
          fi

          # Copy README and LICENSE
          cp README.md release/rushti-windows/ || true
          cp LICENSE release/rushti-windows/ || true

          # Create a build info file
          echo "RushTI Windows Build" > release/rushti-windows/BUILD_INFO.txt
          echo "Version: 2.0.0" >> release/rushti-windows/BUILD_INFO.txt
          echo "Build: Complete build with all features including DAG visualization (onedir mode for fast startup)" >> release/rushti-windows/BUILD_INFO.txt
          echo "Built: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> release/rushti-windows/BUILD_INFO.txt
          echo "Python: $(python --version)" >> release/rushti-windows/BUILD_INFO.txt
          echo "Commit: ${{ github.sha }}" >> release/rushti-windows/BUILD_INFO.txt
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: rushti-windows
          path: release/rushti-windows
          retention-days: 30

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-windows
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Create release archive
        run: |
          cd artifacts/rushti-windows
          zip -r ../rushti-windows.zip .
          cd ..
          ls -la

      - name: Extract version
        id: version
        run: |
          VERSION=$(grep -oP '__version__\s*=\s*"\K[^"]+' src/rushti/__init__.py)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: RushTI v${{ steps.version.outputs.version }}
          body: |
            ## RushTI v${{ steps.version.outputs.version }}

            ### Windows Build

            **rushti-windows.zip** - Complete build with all features:
            - Full TM1 integration and asset management
            - Database admin utilities
            - Statistics and logging
            - DAG visualization support
            - Parallel process execution engine
            - Fast startup (onedir distribution - no temp extraction delay)

            ### Installation

            1. Download **rushti-windows.zip**
            2. Extract to your desired location (keeps directory structure intact)
            3. Copy `config/config.ini.template` to `config.ini` and configure your TM1 connections
            4. (Optional) Copy `config/settings.ini.template` to `settings.ini` for custom defaults
            5. Run `rushti.exe` from command line

            > **Note:** This build uses PyInstaller's onedir mode for fast cold starts.
            > Keep all files in the extracted directory together - the exe requires the bundled libraries.

            ### Requirements

            - Windows 10/11 or Windows Server 2016+

            ### Quick Start

            ```bash
            # Run a task file
            rushti.exe --tasks tasks.txt

            # Visualize DAG (interactive HTML)
            rushti.exe visualize --tasks tasks.txt --output dag.html

            # Get help
            rushti.exe --help
            ```

            See [README.md](https://github.com/cubewise-code/rushti/blob/master/README.md) for complete documentation.
          files: |
            artifacts/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
